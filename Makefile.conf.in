PYTHON_VERSION=@PYTHON_VERSION@
PYTHON_CFLAGS=@PYTHON_CFLAGS@
PYTHON_BASE=@PYTHON_BASE@
PYGTK_INCLUDE=@PYGTK_INCLUDE@
PYTHON_DIR=@PYTHON_DIR@
PYTHON_LIBS=@PYTHON_LIBS@
GTK_INCLUDE=@GTK_GCC_FLAGS@
WITH_PYTHON=@WITH_PYTHON@
WITH_GTK=@WITH_GTK@
WITH_SYSLOG=@WITH_SYSLOG@

DEFS=@DEFS@

TARNAME=@PACKAGE_TARNAME@
VERSION=@PACKAGE_VERSION@
prefix=@prefix@
exec_prefix=@exec_prefix@
datarootdir=@datarootdir@
datadir=@datadir@
bindir=@bindir@
libdir=@libdir@
includedir=@includedir@
docdir=@docdir@

MKDIR=mkdir -p
INSTALL=@INSTALL@
INSTALL_DATA=@INSTALL_DATA@
LN_S=@LN_S@

GNATLIB_LIBRARY_TYPE=relocatable

.PHONY: all examples tests valgrind clean docs install

ifeq (${OS},Windows_NT)
DIRSEP=;
else
DIRSEP=:
endif

## Put this first so that it is the default make target
all:

## This target installs a library project. It needs the following
## variables:
##   ${PROJECT}: name of the project file
##   ${LIBNAME}: name of the library to install (e.g. libgnatlib.so)
##   ${MODULE}:  subdirectory in $libdir that contain the files

# Compute the list of source directories. Would be nicer if gnatls could
# output that info. We are assuming here there are only two of these.
#DIRS=${shell gnat ls -P${PROJECT} -v | grep ${MODULE}}
#SRCDIRS=${wordlist 1,2,${DIRS}}

ifeq (${GNATLIB_LIBRARY_TYPE},relocatable)
LIBNAME:=${LIBNAME}.so
LIBFULL=${LIBNAME}.${VERSION}
else
LIBNAME:=${LIBNAME}.a
LIBFULL=${LIBNAME}
endif

LIBDIR=lib/${MODULE}/${GNATLIB_LIBRARY_TYPE}/

ifeq (${GNATLIB_LIBRARY_TYPE},static)
FPIC=
else
FPIC=-fPIC
endif

.PHONY: buildall cleanall libinstall
buildall:
	@echo Building project ${PROJECT}
	gnatmake -XGNATLIB_LIBRARY_TYPE=${GNATLIB_LIBRARY_TYPE} -P${PROJECT}
cleanall:
	gnatclean -r -q -P${PROJECT}

libinstall: installsources installobj installlinks

# Install the ali files and libraries. The library itself is only copied once
# as ${prefix}/lib/${TARNAME}/${TYPE}/lib*.so.${VERSION}, so that it is visible
# in the library directory of the project files. We cannot install both shared
# and static lib in the same directory, since otherwise ld will always pick up
# the dynamic library

installobj:
	${INSTALL} -p ${LIBDIR}*.ali ${libdir}/${TARNAME}/${GNATLIB_LIBRARY_TYPE}
	${INSTALL} -p ${LIBDIR}${LIBFULL} ${libdir}/${TARNAME}/${GNATLIB_LIBRARY_TYPE}

# Create symbolic links with version numbers for the libraries, in
# ${prefix}/lib/. The library itself is not duplicated and is found in the
# subdirectory ${prefix}/lib/${TARNAME} so that it is visible for the GNAT
# project files. We need to also install a link in lib/${TARNAME} or the linker
# will complain

installlinks:
ifeq (${GNATLIB_LIBRARY_TYPE},relocatable)
	${RM} ${libdir}/${LIBNAME}*
	${RM} ${libdir}/${TARNAME}/${GNATLIB_LIBRARY_TYPE}/${LIBNAME}
	${RM} ${libdir}/${TARNAME}/${GNATLIB_LIBRARY_TYPE}/${LIBNAME}.${basename ${VERSION}}
	cd ${libdir}/${TARNAME}/${GNATLIB_LIBRARY_TYPE}; ${LN_S} ${LIBFULL} ${LIBNAME}
	cd ${libdir}/${TARNAME}/${GNATLIB_LIBRARY_TYPE}; ${LN_S} ${LIBFULL} ${LIBNAME}.${basename ${VERSION}}
	cd ${libdir}; ${LN_S} ${TARNAME}/${GNATLIB_LIBRARY_TYPE}/${LIBFULL} ${LIBNAME}
	cd ${libdir}; ${LN_S} ${TARNAME}/${GNATLIB_LIBRARY_TYPE}/${LIBFULL} ${LIBNAME}.${basename ${VERSION}}
	cd ${libdir}; ${LN_S} ${TARNAME}/${GNATLIB_LIBRARY_TYPE}/${LIBFULL} ${LIBNAME}.${VERSION}
endif

# Install the sources of the library. These can be in multiple source
# directories. The second line generates the *.lgpr files which must contain
# the name of one file per line (therefore the list is generated from ls, from
# the installation directory, but the list of names is computed from the actual
# source dirs). Of course, it would be more convenient if "gnatls" could output
# that info directly.
# We do the expansion of *.ad? directly in the Makefile, since amoung the SRCDIRS
# we in fact have the library dir as well, which doesn't contain any source, and
# install would complain.
installsources:
	${INSTALL} -p ${wildcard ${addsuffix *.ad?, ${SRCDIRS}}} ${includedir}/${TARNAME}
	cd ${includedir}/${TARNAME}; ls ${notdir ${wildcard ${addsuffix *.ad?, ${SRCDIRS}}}} > ${libdir}/gnat/${TARNAME}/${basename ${PROJECT}}.lgpr

